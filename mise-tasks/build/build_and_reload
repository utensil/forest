#!/bin/bash
# Orchestrate XML-to-HTML build and live reload trigger
# AGENT-NOTE: Ensures live reload is triggered only after HTML conversion is complete

set -e

# Step 1: Start XML-to-HTML build in background
mise run build:xml_to_html &
pid1=$!

# Step 2: (Optional) Start HTML-to-live-reload conversion if separate
# If you have a separate conversion step, start it here and capture its PID as pid2
# mise run html_to_live_reload &
# pid2=$!

# Step 3: Wait for both to finish
wait $pid1
# wait $pid2

# Step 4: Trigger live reload (write to trigger files)
mkdir -p build/live

# Find the newest .tree file under trees/**
NEWEST_TREE_FILE=$(find trees -name '*.tree' -print0 | xargs -0 ls -t 2>/dev/null | head -n1)
if [[ -n "$NEWEST_TREE_FILE" ]]; then
    # Write the relative path to updated_file.txt
    echo "$NEWEST_TREE_FILE" > build/live/updated_file.txt
else
    # Fallback: default to index.html
    echo "output/index.html" > build/live/updated_file.txt
fi
touch build/live/trigger.txt

echo "âœ… Build and reload orchestration complete."

# AGENT-NOTE: To customize which file triggers reload, update the logic above.
# AGENT-NOTE: This script is called by mise-tasks/dev for dev workflow orchestration.
